# Guide: Web Assembly åˆè§

## Instruction!!

æœ¬æŒ‡å¼•åŒ…å«é’ˆå¯¹ä¸åŒç¼–ç¨‹è¯­è¨€åŠå·¥å…·é“¾é€‰æ‹©çš„ WebAssembly æŒ‡å¼•ï¼Œè¯·æ ¹æ®ä½ çš„é€‰æ‹©é˜…è¯»æŽ¥ä¸‹æ¥çš„éƒ¨åˆ†ã€‚

**æžé™ç¼–ç¨‹åœºæ™¯éœ€è¦å¤§å®¶è¿…é€Ÿæ ¹æ®å¼€å‘äººå‘˜çš„å…·ä½“æƒ…å†µï¼Œè¿…é€Ÿé€‰æ‹©è§£å†³æ–¹æ¡ˆã€‚**

**è¯·å¤§å®¶å¿«é€Ÿæµè§ˆ Guideï¼Œè¯„ä¼°æœ¬ç»“å¯¹çš„æŠ€æœ¯èƒ½åŠ›ã€æŠ€èƒ½ç‚¹ç­‰å®¢è§‚æ¡ä»¶ï¼Œé€‰æ‹©åˆé€‚çš„ç¼–ç¨‹è¯­è¨€æŠ€æœ¯æ ˆã€‚**

æœ¬æŒ‡å¼•åŒ…å«ä¸€äº›æ€è€ƒé¢˜ï¼Œè™½ç„¶æ— éœ€æŠŠå›žç­”å†™åœ¨å“ªå„¿ï¼Œä½†å¸Œæœ›å¤§å®¶å°½é‡æ‰¾åˆ°ç­”æ¡ˆï¼Œæœ‰åˆ©äºŽåŽç»­çš„ç»“å¯¹é¡¹ç›®è¿›è¡Œã€‚

**æœ¬ Guide ç›¸å…³ä»£ç å·²ä½äºŽä»£ç ä»“åº“ `/G` å†…ã€‚**

### åœ¨å¼€å§‹ä¹‹å‰ï¼šè¿è¡ŒçŽ¯å¢ƒé…ç½®

æœ¬é¡¹ç›®å…¨ç¨‹éœ€è¦ Node.js è¿è¡Œæ—¶æ”¯æŒï¼Œè¯·é¦–å…ˆç¡®ä¿è®¡ç®—æœºä¸Šå®‰è£…äº† **Node.js çš„å½“å‰ LTS (now at v22.14.0) ç‰ˆæœ¬ã€‚**

è¯·è‡ªè¡Œè§£å†³å®‰è£…ï¼Œå¦‚æžœæœºå™¨ä¸Šå·²ç»å®‰è£…äº†æ—§ç‰ˆæœ¬æˆ–æ›´æ–°ç‰ˆæœ¬çš„è¿è¡ŒçŽ¯å¢ƒï¼Œè¯·å®‰è£…è¦æ±‚çš„ç‰ˆæœ¬å¹¶åˆ‡æ¢åˆ°è¯¥ç‰ˆæœ¬ï¼šå¯¹äºŽè¿™ç§éœ€è¦ç®¡ç†å¤šä¸ª Node.js ç‰ˆæœ¬çš„æƒ…å†µï¼ŒæŽ¨èå¤§å®¶æœå¯»å¹¶ä½¿ç”¨ [nvm](https://github.com/nvm-sh/nvm)ï¼Œä¹Ÿæœ‰ [Windows ç‰ˆæœ¬](https://github.com/coreybutler/nvm-windows) å–”ã€‚

### AssemblyScript

[AssemblyScript](https://www.assemblyscript.org/) ï¼ˆä»¥ä¸‹ç•¥ç§° ASï¼‰æ˜¯ä¸€ç§é‡‡ç”¨ä¸Ž JavaScript/TypeScript ç›¸è¿‘è¯­æ³•è®¾è®¡ï¼Œä½†å¼•å…¥ WebAssembly ç±»åž‹çš„ç¼–ç¨‹è¯­è¨€ã€‚å¦‚æžœä½ ç†Ÿæ‚‰ JS/TS å¼€å‘ï¼Œåº”è¯¥ä¼šæ„Ÿåˆ°éžå¸¸å¥½ä¸Šæ‰‹ï¼é¡ºå¸¦ä¸€æè¯·æ”¾è½»æ¾â€”â€”æœ¬é¡¹ç›®è®¾è®¡çš„ä»»åŠ¡å¹¶ä¸ä¼šéœ€è¦å¯¹é«˜çº§è¯­è¨€ç‰¹æ€§æœ‰äº†è§£ï¼Œå› æ­¤å³ä¾¿ä½ ä»ŽæœªæŽ¥è§¦è¿‡ JS/TSï¼ˆçœŸçš„ä¸€ç‚¹ä¹Ÿæ²¡å†™è¿‡å—ï¼ï¼‰ï¼Œåº”å½“ä¹Ÿä¸ä¼šå› ä¸ºé€‰æ‹© AssemblyScript å®Œæˆç»“å¯¹ä»»åŠ¡è€Œé‡åˆ°æ ¹æœ¬åšä¸æ¥çš„éšœç¢ã€‚

AS é€šè¿‡å¼•å…¥ä¸Ž Wasm å……åˆ†å¯¹æŽ¥çš„ç±»åž‹ç³»ç»Ÿã€å¹¶å¯¹è¯­æ³•ç‰¹æ€§è¿›è¡Œåˆç†çš„é™ç¼©å’Œè°ƒæ•´ï¼Œå®žçŽ°é™æ€åŒ–å’Œ AOT ç¼–è¯‘ã€‚

> **â†’ ðŸ“– [æ€è€ƒé¢˜ A1] AssemblyScript ä¸Ž JavaScript/TypeScript æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ**

æŽ¥ä¸‹æ¥ï¼Œä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ AS å®Œæˆæœ¬ä»»åŠ¡çš„é¡¹ç›®å¼€å‘ã€‚

é¦–å…ˆï¼Œè¯·åˆ›å»ºç›®å½• `g-as` å¹¶åˆ‡æ¢åˆ°è¯¥ç›®å½•ï¼š

```bash
mkdir g-as
cd g-as
```

æ‰§è¡Œé¡¹ç›®çš„åˆå§‹åŒ–ï¼š

```bash
npm init
npm install --save-dev assemblyscript
npx asinit .
```

åœ¨ç›®å½• `/assembly` ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°å·²åˆå§‹åŒ–çš„ã€åŒ…å«ä¸€ä¸ªé»˜è®¤çš„å¯¼å‡ºå‡½æ•° `add()` çš„ Wasm æ¨¡å—å…¥å£ `index.ts`ï¼›ä½ å¯ä»¥è‡ªç”±ä¿®æ”¹ä»¥å®Œæˆä½ çš„ä»£ç å®žçŽ°ã€‚

å½“ä½ ç¼–å†™å®Œæˆä»£ç åŽï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œç¼–è¯‘ï¼š

```bash
npm run asbuild
```

> **â†’ ðŸ“– [æ€è€ƒé¢˜ A2] æ‰§è¡Œ `npm run asbuild` åŽï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

ä½ å¯ä»¥åœ¨ `/tests/index.js` ä¸­ç¼–å†™æµ‹è¯•ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œæµ‹è¯•ï¼š

```bash
npm test
```

ä½ å¯ä»¥å‚ç…§[å®˜æ–¹æ–‡æ¡£](https://www.assemblyscript.org/getting-started.html#setting-up-a-new-project)æ¥äº†è§£æ›´å¤šã€‚

### Rust

[Rust](https://www.rust-lang.org/) æ˜¯æ³¨é‡æ€§èƒ½ã€å¯é æ€§ä¸Žç”Ÿäº§åŠ›çš„ç¼–ç¨‹è¯­è¨€ðŸ¦€ã€‚ä½œä¸ºä¸€ä¸ªè¯žç”ŸäºŽ Mozillaï¼ŒæŠŠâ€œèµ‹èƒ½ï¼ˆEmpowermentï¼‰â€å½“ä½œè‡ªå·±å…³é”®è¯çš„æ–°å…´ï¼ˆç®—æ˜¯æ¯”è¾ƒæ–°å•¦ï¼ï¼‰ç¼–ç¨‹è¯­è¨€ï¼ŒRust å¯¹äº’è”ç½‘é¢†åŸŸåº”ç”¨ä¹Ÿç›¸å½“å…³æ³¨ï¼Œéƒ¨åˆ†ä½“çŽ°åœ¨ä»ŽåŸºç¡€è®¾æ–½å±‚é¢å¯¹ WebAssembly å·¥å…·é“¾çš„å¹¿æ³›é€‚é…å’Œæ”¯æŒä¸Šã€‚

æ—¢ç„¶ä½ é€‰æ‹© Rustï¼Œæƒ³å¿…ä½ åº”è¯¥å·²ç»æŽ¥è§¦è¿‡è¿™é—¨è¯­è¨€äº†â€”â€”å³ä¾¿æ²¡æœ‰æŽ¥è§¦è¿‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸€é—¨ç”±äºŽè®¸å¤šè¯­è¨€å±‚é¢çš„ä¼˜è‰¯è®¾è®¡è€Œæ˜“ä¸Šæ‰‹ã€æ˜“ä½¿ç”¨çš„è¯­è¨€ï¼ä½¿ç”¨ Rust å®ŒæˆæŽ¥ä¸‹æ¥çš„ä»»åŠ¡æœ€ç›´æŽ¥çš„å¥½å¤„æ˜¯èƒ½å¤Ÿå¾—ç›ŠäºŽå…¶å¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿ã€‚é¡ºå¸¦ä¸€æè¯·æ”¾è½»æ¾â€”â€”æœ¬é¡¹ç›®è®¾è®¡çš„ä»»åŠ¡å¹¶ä¸ä¼šéœ€è¦å¯¹é«˜çº§è¯­è¨€ç‰¹æ€§æœ‰äº†è§£ï¼Œå› æ­¤å³ä¾¿ä½ ä»ŽæœªæŽ¥è§¦è¿‡ Rustï¼ˆè¿™ä¸ªå¯èƒ½è¿˜è›®ç»å¸¸çš„å•¦ï¼‰ï¼Œåº”å½“ä¹Ÿä¸ä¼šå› ä¸ºé€‰æ‹© Rust å®Œæˆç»“å¯¹ä»»åŠ¡è€Œé‡åˆ°æ— æ³•é€¾è¶Šçš„éšœç¢ã€‚

å¦‚æžœä½ ä»ŽæœªæŽ¥è§¦è¿‡ Rustï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„èµ·ç‚¹æ˜¯ [Rust ç¨‹åºè®¾è®¡è¯­è¨€ï¼ˆ"the book"ï¼‰](https://doc.rust-lang.org/book/)ï¼Œå¦æœ‰éžå®˜æ–¹çš„[ä¸­æ–‡ç‰ˆ 1](https://kaisery.github.io/trpl-zh-cn/)ï¼Œ[ä¸­æ–‡ç‰ˆ 2](https://rustwiki.org/zh-CN/book/)å¯ä¾›é˜…è¯»ã€‚å¤§æ¦‚è¯»åˆ°ç¬¬ä¸‰ç« å°±å·®ä¸å¤šäº†ï¼è™½ç„¶ä¸Šæ‰‹ç¼–ç¨‹è¯­è¨€çš„æ–¹æ³•å¯èƒ½æ›´å¤šåœ°ä¾é â€œåšä¸­å­¦â€â€”â€”

æŽ¥ä¸‹æ¥ï¼Œä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ Rust å®Œæˆæœ¬ä»»åŠ¡çš„é¡¹ç›®å¼€å‘ã€‚

é¦–å…ˆï¼Œè¯·åˆ‡æ¢è‡³ç›®å½• `g_rust`ï¼š

```bash
cd g_rust
```

ä½ ä¼šå‘çŽ°è¿™é‡Œå·²ç»å­˜åœ¨ä¸€äº›ä»£ç ï¼Œä»£ç æ¡†æž¶æ˜¯é€šè¿‡ä»¥ä¸‹è¿™äº›å‘½ä»¤æ¥ç”Ÿæˆçš„ï¼š

```bash
cargo new --lib g_rust
cd g_rust
cargo add wasm-bindgen
```

è¿˜è¿›è¡Œäº†ä¸€äº›æ‰‹å·¥çš„æ”¹åŠ¨ï¼ŒåŒ…æ‹¬ï¼š

- åœ¨ `Cargo.toml` ä¸­å¢žåŠ äº†ï¼š

  ```toml
  [lib]
  crate-type = ["cdylib", "rlib"]
  ```

- åœ¨ `lib.rs` ä¸­ç¼–å†™äº†ä»£ç ã€‚

ä½ å¯ä»¥å‚è€ƒ [Rust&Wasm æ–‡æ¡£](https://rustwasm.github.io/docs/book/introduction.html) ä»¥åŠ [wasm-pack æ–‡æ¡£](https://rustwasm.github.io/docs/wasm-pack/introduction.html) å’Œ [wasm-bindgen æ–‡æ¡£](https://rustwasm.github.io/wasm-bindgen/) æ¥äº†è§£æ›´å¤šå†…å®¹ã€‚

å½“ä½ ç¼–å†™å®Œæˆä»£ç åŽï¼Œè¯·å‚ç…§å®˜æ–¹æŒ‡å¼•[å®‰è£…å¹¶é…ç½® `wasm-pack`](https://rustwasm.github.io/wasm-pack/installer/)ï¼ŒéšåŽé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œç¼–è¯‘å’Œæ‰“åŒ…çŽ°æœ‰é¡¹ç›®ä¸º Node.js æ¨¡å—çš„æ“ä½œï¼š

```bash
wasm-pack build --target nodejs
```

> **â†’ ðŸ“– [æ€è€ƒé¢˜ R1] æµè§ˆ `Cargo.toml`ï¼Œè¯·é—®ç¬¬ 9 è¡Œçš„è®¾ç½®é¡¹ä¸­ï¼š `crate-type="cdylib"` çš„ä½œç”¨æ˜¯ï¼Ÿå¯ä»¥ä»Žä¸Šè¿°æ–‡æ¡£å½“ä¸­å¯»æ‰¾ç­”æ¡ˆã€‚**

> **â†’ ðŸ“– [æ€è€ƒé¢˜ R2] æµè§ˆ `lib.rs`ï¼Œè¯·é—®ç¬¬ 3 è¡Œçš„å±žæ€§ï¼ˆAttributeï¼‰æ³¨è§£`#[wasm_bindgen]` çš„ä½œç”¨æ˜¯ï¼Ÿè¯·å°è¯•åˆ é™¤æŽ‰è¿™ä¸€æ³¨è§£é‡æ–°è¿è¡Œä¸Šé¢è¿™æ¡ `wasm-pack` çš„ç¼–è¯‘å’Œæ‰“åŒ…æŒ‡ä»¤ï¼Œæ£€æŸ¥åˆ é™¤å‰åŽ `/pkg` å†…ç”Ÿæˆçš„æ–‡ä»¶å‘ç”Ÿçš„å˜åŒ–ï¼›å¹¶è¯·å‚è€ƒä¸Šè¿°æ–‡æ¡£å®Œå–„ç­”æ¡ˆã€‚**

ä½ å¯ä»¥åœ¨ `/src/lib.rs` ä¸­ç¼–å†™æµ‹è¯•ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œæµ‹è¯•ï¼š

```bash
cargo test
```

### C/C++

**è¯·è°¨æ…Žé€‰æ‹© C/C++ ä½œä¸ºå®žçŽ°è¯­è¨€ï¼Œè™½ç„¶å®ƒå¯èƒ½æœ‰æ›´ç†Ÿæ‚‰ã€æ€§èƒ½ä¹Ÿè®¸åœ¨æŸäº›æƒ…å½¢ä¸‹ç•¥æœ‰æ”¶ç›Šç­‰å¯èƒ½çš„å¥½å¤„ï¼Œä½†ä¹Ÿæœ‰æ›´éœ€è¦å¯¹ç›¸å…³å·¥å…·é“¾æœ‰è¾ƒä¸ºæ·±å…¥çš„ç†è§£è¿™æ ·çš„æŠ€æœ¯è¦æ±‚ã€‚**

æœ‰çš„åŒå­¦å¯èƒ½å¯¹ AS æˆ–è€… Rust éƒ½ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥å¸Œæœ›ä½¿ç”¨ C/C++ è¯­è¨€å®Œæˆæœ¬æ¬¡ç»“å¯¹ç¼–ç¨‹ã€‚ä¸è¿‡ä¸‘è¯è¯´åœ¨å‰é¢ï¼ŒC/C++ å¯¹ Wasm çš„æ”¯æŒå¹¶ä¸å®Œç¾Žï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼Œé€‰æ‹© C/C++ï¼Œæ„å‘³ç€ä½ å¿…é¡»é™ä¸‹å¿ƒæ¥æ…¢æ…¢æ£é¼“çŽ¯å¢ƒï¼Œå¹¶å€Ÿç”±å„ç§æŠ€æœ¯èµ„æ–™æ·±åº¦ç†è§£ C/C++ å’Œ Wasm çš„äº¤äº’æ–¹å¼ã€‚

æœ¬ç¯‡æ•™ç¨‹ä¸»è¦å‚è€ƒäº† [Wasmå®˜æ–¹æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/WebAssembly/Guides/C_to_Wasm)ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥åŽ»é˜…è¯»åŽŸæ–‡ã€‚

æŽ¥ä¸‹æ¥ï¼Œä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ C/C++ å®ŒæˆåŽç»­çš„é¡¹ç›®å¼€å‘ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæœ¬ç¯‡æ•™ç¨‹é»˜è®¤åœ¨ Ubuntu22.04 çŽ¯å¢ƒä¸‹å¼€å‘ï¼Œä¸”é»˜è®¤ä½¿ç”¨ C è¯­è¨€ï¼ˆè€Œéž C++ï¼‰ï¼Œä½¿ç”¨Windowsï¼ŒMacOSï¼Œæˆ–å…¶ä»–Linuxå‘è¡Œç‰ˆçš„åŒå­¦ï¼Œè¯·æ³¨æ„ä½ éœ€è¦ä½¿ç”¨çš„å‘½ä»¤å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·å…ˆç¡®ä¿ä½ çš„ç”µè„‘å·²å®‰è£… Python3.6 ä»¥ä¸Šç‰ˆæœ¬ï¼Œä¸”èƒ½å¤Ÿæ­£ç¡®ç¼–è¯‘æ™®é€šçš„ C ä»£ç ï¼ˆä½¿ç”¨ gcc/clang/msvcï¼‰ã€‚

é¦–å…ˆéœ€è¦å®‰è£… C åˆ° Wasm çš„ç¼–è¯‘å™¨ [emscripten](https://emscripten.org/)ã€‚è¿™ä¸€éƒ¨åˆ†åŒå­¦ä»¬ä¹Ÿå¯ä»¥ç›´æŽ¥å‚è€ƒ [emscriptenå®˜ç½‘æ•™ç¨‹](https://emscripten.org/docs/getting_started/downloads.html)ã€‚

1. æ‰¾ä¸€ä¸ªåˆé€‚çš„ç›®å½• clone æˆ–ç›´æŽ¥ä¸‹è½½ emsdkï¼šhttps://github.com/emscripten-core/emsdk

   > ä½¿ç”¨ `git clone https://github.com/emscripten-core/emsdk.git` æˆ–ä¸‹è½½ zip åŽè§£åŽ‹

2. è¿›å…¥ emsdk ç›®å½•ï¼Œå¹¶è¿è¡Œè„šæœ¬èŽ·å–æœ€æ–°å·¥å…·é“¾ï¼š

   >```bash
   ># è¿›å…¥emsdkç›®å½•
   >cd emsdk
   ># ä¸‹è½½æœ€æ–°å·¥å…·é“¾
   >./emsdk install latest
   ># æ¿€æ´»æœ€æ–°å·¥å…·é“¾
   >./emsdk activate latest
   ># å°†å·¥å…·é“¾æ·»åŠ åˆ°PATH
   >source ./emsdk_env.sh
   >```
   >
   >æ³¨æ„ï¼šå¯¹ Windows ç”¨æˆ·æ¥è¯´ï¼Œè¯·ä½¿ç”¨ `emsdk.bat` å’Œ `emsdk_env.bat`

3. éªŒè¯å®‰è£…æ— è¯¯

   > é”®å…¥ `emcc --version` å‘½ä»¤ï¼Œè‹¥æ­£ç¡®å±•ç¤ºäº† emcc çš„ç‰ˆæœ¬åˆ™è¯´æ˜Žå®‰è£…æ­£ç¡®æ— è¯¯ã€‚

æ³¨æ„ï¼šç¬¬äºŒæ­¥æ¿€æ´»çš„å·¥å…·é“¾çŽ¯å¢ƒåªåœ¨å½“å‰ shell ä¸­æœ‰æ•ˆï¼Œå¦‚æžœéœ€è¦ä¿æŒé•¿æœŸæœ‰æ•ˆï¼Œå¯ä»¥è€ƒè™‘å°† `source ./emsdk_env.sh` æ·»åŠ åˆ°å¯¹åº” shell çš„ç™»å½•çŽ¯å¢ƒé…ç½®ä¸­ï¼ˆå¦‚ `.bashrc`ï¼‰

çŽ°åœ¨å¯ä»¥æ­£å¼å¼€å§‹å†™ä»£ç äº†ï¼

æ–°å»ºå¹¶åˆ‡æ¢è‡³ä¸€ä¸ªç›®å½• `g_c`ï¼Œå¹¶æ–°å»ºä¸€ä¸ª C æºæ–‡ä»¶ï¼ˆå¦‚ `main.c`ï¼‰ï¼Œåœ¨å…¶ä¸­å®Œæˆä½ çš„å‡½æ•° `func` çš„å®žçŽ°ã€‚

æŽ¥ç€ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ç¼–è¯‘ä½ çš„Cç¨‹åºï¼š

```bash
emcc main.c -O3 -o module.cjs \
  -s EXPORTED_FUNCTIONS='["_func"]' \
  -s EXPORTED_RUNTIME_METHODS='["cwrap"]' \
  -s WASM=1 -s MODULARIZE=1
```

> è§£é‡Šï¼š
>
> `main.c` åº”ä¸ºä½ çš„Cæºç¨‹åºåå­—
>
> `-O3` å¼€å¯éžå¸¸é‡è§†æ€§èƒ½çš„ç¼–è¯‘ä¼˜åŒ–
>
> `module.cjs` ä¸ºç”Ÿæˆçš„ `cjs` æ–‡ä»¶è·¯å¾„
>
> `EXPORTED_FUNCTIONS` åˆ™è¡¨æ˜Žäº†å“ªäº›å‡½æ•°å¯ä»¥åœ¨ Wasm ä¸­è°ƒç”¨ï¼ˆæ³¨æ„**å‡½æ•°åç§°å‰æœ‰ä¸ªä¸‹åˆ’çº¿**ï¼‰
>
> `EXPORTED_RUNTIME_METHODS` åˆ™è¡¨æ˜Žäº†è¦ä½¿ç”¨å“ªäº›èƒ¶æ°´å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `cwrap` æ¯”è‡ªå·±ç¼–å†™èƒ¶æ°´ä»£ç æ–¹ä¾¿
>
> `WASM=1` åˆ™è¡¨ç¤ºäº†è¦ç”Ÿæˆ `wasm`ï¼ˆå’Œå‰æ–‡æŒ‡å®šçš„ `cjs` æ–‡ä»¶è·¯å¾„å’Œåå­—ç›¸åŒï¼Œåªæ˜¯æ”¹äº†ä¸ªåŽç¼€ï¼‰
>
> `MODULARIZE=1` è¡¨ç¤ºè¦ç”Ÿæˆ ESModule ç±»åž‹çš„èƒ¶æ°´ä»£ç 

éšåŽæ–°å»ºæ–‡ä»¶ `bridge.js` ä½œä¸ºè°ƒç”¨ Wasm çš„æ¡¥æ¢ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```js
// ä»Žç¼–è¯‘ç”Ÿæˆçš„ cjs æ–‡ä»¶ä¸­å¯¼å…¥ Wasm Module
import Module from './module.cjs'

// è€ƒè™‘åˆ°çœŸå®žç½‘é¡µåœºæ™¯ï¼Œé€šè¿‡ç½‘ç»œåŠ è½½ wasm å¯èƒ½å¾ˆæ…¢ï¼Œæ‰€ä»¥ Module æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œ
// è€Œæˆ‘ä»¬æ˜¯æœ¬åœ°çš„çŽ¯å¢ƒï¼Œè¿™é‡Œç›´æŽ¥ await å°±å¥½
const wasm = await Module();
// ä½¿ç”¨ cwrap å‡½æ•°æ–¹ä¾¿çš„åŒ…è£… C ä¸­çš„å‡½æ•°
// ä½¿ç”¨æ–¹æ³•ï¼šcwrap(å‡½æ•°å, è¿”å›žå€¼ç±»åž‹, å‚æ•°åˆ—è¡¨)
const c_func = wasm.cwrap('func', 'number', ['number', 'array', 'number']);

// æµ‹è¯•æ—¶çœŸæ­£è°ƒç”¨çš„æ–¹æ³•
export const func = (flag, seq, size) => {
    // ç”±äºŽ seq è¿™æ ·çš„ jsæ•°ç»„ æ²¡æœ‰å¯¹åº”çš„Cè¯­è¨€ç±»åž‹ï¼Œ
    // è€ŒCè¯­è¨€çš„æ•°ç»„å…¥å‚å‡è¡¨çŽ°ä¸ºæŒ‡é’ˆï¼Œæ‰€ä»¥éœ€è¦åŒ…è£…ä¸€ä¸‹
    let array = new Uint8Array((new Int32Array(seq)).buffer);
    return c_func(flag, array, size);
};
```

ä½ å¯ä»¥é‡‡ç”¨ä½ ç†Ÿæ‚‰çš„æ–¹æ³•æ¥å®žçŽ°å•å…ƒæµ‹è¯•ã€‚

> â†’ ðŸ“– [æ€è€ƒé¢˜ C1] ä¸Šè¿° `bridge.js` ä»£ç ä¸­ï¼Œä¸ºä»€ä¹ˆè¦æŠŠ seq åŒ…è£…ä¸¤å±‚å†ä¼ é€’ç»™ Wasmï¼Ÿå¦‚æžœä¸åŒ…è£…ï¼ˆç›´æŽ¥è°ƒç”¨ `c_func(flag, array, size)` ä¼šæœ‰ä»€ä¹ˆæ•ˆæžœï¼Ÿå¦‚æžœåªåŒ…è£…ä¸€å±‚ï¼ˆå³ `c_func(flag, new Int32Array(seq), size)`ï¼‰ä¼šæœ‰ä»€ä¹ˆæ•ˆæžœï¼Ÿå¦‚æžœç›´æŽ¥åŒ…è£… Uint8Array ï¼ˆå³ `c_func(flag, new Uint8Array(seq), size)`ï¼‰åˆä¼šæœ‰ä»€ä¹ˆæ•ˆæžœï¼Ÿå°† `Uint8Array` æ”¹ä¸º `Int8Array` ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿå°è¯•æŽ¢ç©¶å°† JS æ•°ç»„è½¬åŒ–åˆ° C æŒ‡é’ˆçš„åŽŸç†ã€‚

æœ€åŽï¼Œå¯¹äºŽæ‰“ç®—ä½¿ç”¨C++ä½œä¸ºç¼–ç¨‹è¯­è¨€çš„åŒå­¦ï¼Œè¿˜éœ€è¦é¢å¤–æŽ¢ç©¶ä¸€äº›å†…å®¹ï¼š

> â†’ ðŸ“– [æ€è€ƒé¢˜ C2] ï¼ˆå¦‚æžœä¸ä½¿ç”¨ C++ åˆ™å¯ä»¥å¿½ç•¥æ­¤é—®é¢˜ï¼‰ç›´æŽ¥å°† C æºæ–‡ä»¶åŽç¼€æ”¹ä¸º cpp èƒ½é¡ºåˆ©é€šè¿‡ç¼–è¯‘å—ï¼Ÿå¦‚æžœä¸èƒ½ï¼Œå¦‚ä½•æ”¹åŠ¨æ‰èƒ½é€šè¿‡ç¼–è¯‘å‘¢ï¼Ÿ

å¦‚æžœå¯¹äºŽä¸¤ä¸ªæ€è€ƒé¢˜å®Œå…¨æ²¡æœ‰å¤´ç»ªï¼Œæˆ–è®¸å¯ä»¥æœå¯»å…³äºŽ **Wasm è™šæ‹Ÿæœºå†…å­˜æ¨¡åž‹**ã€**C/C++ to Wasm åŽç«¯å®žçŽ°** çš„æŠ€æœ¯æ–‡ç« ã€‚

å¦‚æžœå®žåœ¨æ— æ³•ç†è§£ç›¸å…³ä¿¡æ¯ï¼Œæƒ³å¿…åŽé¢çš„å®žçŽ°ä¼šæ¯”è¾ƒéš¾ï¼Œå›žå¤´æ˜¯å²¸å–”â€”â€”ï¼

> By @KumaXX (AS, rust) and @TobyShi (C/C++)